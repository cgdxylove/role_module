<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
          "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dzfp.cloud.user.dao.RoleDao">
	<!--角色列表查询 -->
	<select id="queryRolesList" parameterType="java.util.Map" resultType="java.util.HashMap">
		select t1.jsid , t1.nsrsbh,t1.jsmc , t1.yxbz , t1.jslx,
			IF(t1.lrsj='0000-00-00 00:00:00','null',DATE_FORMAT (t1.lrsj,'%Y-%m-%d %H:%i:%S')) lrsj,
			IF(t1.xgsj='0000-00-00 00:00:00','null',DATE_FORMAT (t1.xgsj,'%Y-%m-%d %H:%i:%S')) xgsj
		from spu_t_js t1 where 1=1
		<if test="nsrsbh != null and nsrsbh != ''">
			and t1.nsrsbh = #{nsrsbh}
		</if>
		<if test="jsmc != null and jsmc != ''">
			and t1.jsmc  like CONCAT(CONCAT('%', #{ jsmc}),'%') 
		</if>
		<if test="yxbz != null and yxbz != ''">
			and t1.yxbz  =#{yxbz}
		</if>
		order by lrsj  desc
	</select>
	<!-- 查询某一角色的菜单-->
	<select id="queryJsMenusList" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		SELECT distinct t4.cdid id,t4.cdmc name,t4.s_cdid pId,
			IF(t3.yxq_q='0000-00-00 00:00:00','null',DATE_FORMAT (t3.yxq_q,'%Y-%m-%d %H:%i:%S'))	 yxq_q,
			IF(t3.yxq_z='0000-00-00 00:00:00','null',DATE_FORMAT (t3.yxq_z,'%Y-%m-%d %H:%i:%S'))	 yxq_z 
		from   spu_t_jscd_gl t3, spu_t_cd_new  t4
		where  t4.cdid=t3.cdid    
		<if test="jsid != null and jsid != ''">
			and t3.jsid=#{jsid}
		</if> 
		and t4.yxbz='Y' 
	</select>
	<!-- 删除该角色下角色菜单数据 -->
	<delete id="deleteRoleMenu" parameterType="java.util.Map">
		delete from
		spu_t_jscd_gl where  jsid = #{jsid}
	</delete>
	<!-- 单个角色角色表删除 -->
	<delete id="deleteRole"  parameterType="java.util.Map">
		delete from spu_t_js   where 1=1
		<if test="nsrsbh != null and nsrsbh != ''">
			and  nsrsbh = #{nsrsbh}
		</if>
		<if test="jsid != null and jsid != ''">
			and  jsid = #{jsid}
		</if>
	</delete>
	<!-- 批量删除角色 -->
	<delete id="deleteAllR" parameterType="String" flushCache="false">
		delete from spu_t_js
		where
		jsid in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
			#{item.jsid}
		</foreach>
	</delete> 
	<delete id="deleteRoleMenus" parameterType="java.util.Map">
		delete from
		spu_t_jscd_gl where  jsid in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
			#{item.jsid}
		</foreach>
	</delete>
	<!--判断角色是否存在 -->
	<select id="queryRoleIsExists" parameterType="java.util.Map" resultType="int">
		select  count(*) count
		from spu_t_js t1 where jsmc=#{jsmc} and nsrsbh=#{nsrsbh}
	</select>
	<!-- 角色新增 -->
	<insert id="insertRole" parameterType="java.util.Map">
		INSERT INTO spu_t_js ( jsid , nsrsbh , jsmc , yxbz , jslx , lrsj )
		VALUES (#{jsid},  #{nsrsbh}, #{jsmc}, #{yxbz}, #{jslx}, now() )
	</insert> 
	
	<!-- 批量新增角色菜单-->
 	<insert id="insertRoleMenu" parameterType="java.util.Map">
		INSERT INTO  spu_t_jscd_gl ( id ,  jsid ,  cdid ,  yxbz ,  yxq_q ,  yxq_z ,  czr ,  lrsj  ) 
		VALUES
		<foreach collection="list" item="invMap" index="index" separator=",">
		(#{invMap.id},
		 #{invMap.jsid},
		 #{invMap.cdid},
		 #{invMap.yxbz},
		 #{invMap.yxq_q},
		 #{invMap.yxq_z},
		 #{invMap.czr},
		 now())
		</foreach>
	</insert>
	<!-- 角色修改 --> 
	<update id="updateRole" parameterType="java.util.Map">
		update spu_t_js set
		 jsmc =#{jsmc},  yxbz =#{yxbz}, xgsj=now()
		where jsid = #{jsid}
	</update>	
	<!-- 角色查询 --> 
	<select id="queryJs" parameterType="java.util.Map" resultType="java.util.HashMap">
		select * from spu_t_js 
		where nsrsbh=#{nsrsbh}
		and jsmc !='管理员' and yxbz='Y'
	</select>
	<!--菜单列表查询 -->
	<select id="queryMenusList" parameterType="java.util.Map"
		resultType="java.util.HashMap">
	 	SELECT distinct t4.cdid id,t4.cdmc name,t4.s_cdid pId,t4.cdxh cdxh,
			IF(t3.yxq_q='0000-00-00 00:00:00','null',DATE_FORMAT (t3.yxq_q,'%Y-%m-%d %H:%i:%S'))	 yxq_q,
			IF(t3.yxq_z='0000-00-00 00:00:00','null',DATE_FORMAT (t3.yxq_z,'%Y-%m-%d %H:%i:%S'))	 yxq_z ,'true' open
		from  spu_t_yhjs_gl t2,spu_t_jscd_gl t3, spu_t_cd_new  t4
		where    t2.jsid=t3.jsid and t4.cdid=t3.cdid  
		<if test="yhid != null and yhid != ''">
				 and t2.yhid=#{yhid}
		</if> 
		and t4.yxbz='Y' 
	 order by pId,cdxh 
	</select>
	<!-- 根据纳税人识别号查找有效期 -->
	<select id="searchYxq" parameterType="java.util.Map"
		resultType="java.util.Map">
		select  yxq_q,yxq_z 
		from spu_t_zhxx where  nsrsbh=#{nsrsbh}
	</select> 
</mapper>