<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dzfp.cloud.user.dao.InvoiceMessageDao">
	<select id="queryMessageList"  parameterType="java.util.Map" resultType="java.util.Map">
		select t.id,t.ghf_user_id,t.title,DATE_FORMAT(t.creat_time,'%Y-%m-%d %H:%i:%s') as create_time ,
			t.ready_flag,b.name as readyName,t.type,a.name as typeName,t.xhf_user_id,t.content,t.is_reply,t.is_opt,t.redirect_url 
		from t_jx_invoice_message  t
		LEFT JOIN t_jx_invoice_dictionary  a on t.type = a.code and a.zdlx_code='10016' 
		left join t_jx_invoice_dictionary b on t.ready_flag = b.code and b.zdlx_code ='10017'
		where 1=1
		  <if test="nsrzh !=null and nsrzh != ''">
		  and nsrsbh in (select nsrsbh from t_sbh_zh_gx where nsrzh = #{nsrzh})
		  </if>
		  <if test="title !=null and title != ''">
		  and  t.title like '%#{title}%'
		  </if>
		  <if test="readyFlag !=null and readyFlag != ''">
		  and	t.ready_flag= #{readyFlag}
		  </if>
		  <if test="type !=null and type != ''">
		  and	t.type = #{type}
		  </if>
		  <if test="startTime !=null and endTime!='' and endTime !=null and endTime!=''">
		  and t.creat_time	BETWEEN  #{startTime} and #{endTime}
		  </if>
		  order by t.creat_time desc
	</select>	
	
	<sql id="allColumns">
		id,ghf_user_id,title,creat_time,ready_flag,
		type,xhf_user_id,content,is_reply
		is_opt,redirect_url
	</sql>
	<!-- 进项消息推送批量录入 -->
	<insert id="insertInvoiceMessage">
		insert into t_jx_invoice_message
		(
			<include refid="allColumns"></include>
		)
		values
		<foreach collection="list" item="invoice" separator=",">
			(
			#{id}, #{ghf_user_id}, #{title}, #{creat_time}, #{ready_flag},
			#{type}, #{xhf_user_id}, #{content}, #{is_reply}
			#{is_opt}, #{redirect_url}
			)
		</foreach>
	</insert>
	<!-- 进项消息推送单条录入 -->
	<insert id="insertOneInvoiceMessage">
		insert into t_jx_invoice_message
		(
			<include refid="allColumns"></include>
		)
		values
		(
			#{id}, #{ghf_user_id}, #{title}, #{creat_time}, #{ready_flag},
			#{type}, #{xhf_user_id}, #{content}, #{is_reply}
			#{is_opt}, #{redirect_url}
		)
	</insert>
	<update id="updateInvoiceMessage">
			update t_jx_invoice_message
			<set>
				<if test="ghf_user_id!=null">ghf_user_id=#{ghf_user_id},</if>
				<if test="title!=null">title=#{title},</if>
				<if test="creat_time!=null">creat_time=#{creat_time},</if>
				<if test="ready_flag!=null">ready_flag=#{ready_flag},</if>
				<if test="type!=null">type=#{type},</if>
				<if test="xhf_user_id!=null">xhf_user_id=#{xhf_user_id},</if>
				<if test="content!=null">content=#{content},</if>
				<if test="is_reply!=null">is_reply=#{is_reply},</if>
				<if test="is_opt!=null">is_opt=#{is_opt},</if>
				<if test="redirect_url!=null">redirect_url=#{redirect_url},</if>
			</set>
			WHERE id in
		    <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
		        #{item.id}
		    </foreach>
	</update>
	
	<update id="updateOneInvoiceMessage">
			update t_jx_invoice_message
			<set>
				<if test="ghf_user_id!=null">ghf_user_id=#{ghf_user_id},</if>
				<if test="title!=null">title=#{title},</if>
				<if test="creat_time!=null">creat_time=#{creat_time},</if>
				<if test="ready_flag!=null">ready_flag=#{ready_flag},</if>
				<if test="type!=null">type=#{type},</if>
				<if test="xhf_user_id!=null">xhf_user_id=#{xhf_user_id},</if>
				<if test="content!=null">content=#{content},</if>
				<if test="is_reply!=null">is_reply=#{is_reply},</if>
				<if test="is_opt!=null">is_opt=#{is_opt},</if>
				<if test="redirect_url!=null">redirect_url=#{redirect_url},</if>
			</set>
			where id = #{id}	
	</update>
	<!-- 查询消息推送信息 -->
	<select id="queryInvoiceMessage"  parameterType="java.util.Map" resultType="java.util.Map">
	  select 
	   <include refid="allColumns"></include>
	    from t_jx_invoice_message where ready_flag='1'
		<!-- 	    <if test="userId !=null and userId != ''"> -->
		<!-- 		  and  xhf_user_id = #{userId} -->
		<!-- 		</if> -->
		<!-- 需求目前改为：登陆人账户所在公司下，其他账号也可以看见登陆人账户下预警数据 --> 
		and  nsrsbh in (select nsrsbh from t_sbh_zh_gx where nsrzh = #{nsrzh})
	    order by creat_time desc
	    limit 3 
	</select>
	<!-- 查询消息推送数量 未读-->
	<select id="queryOneInvoiceMessage"  parameterType="java.util.Map" resultType="java.lang.Integer">
	  select count(1) from t_jx_invoice_message where ready_flag='1'
		<!-- 	  <if test="userId !=null and userId != ''"> -->
		<!-- 		  and  xhf_user_id = #{userId} -->
		<!-- 	  </if> -->
		<!-- 需求目前改为：登陆人账户所在公司下，其他账号也可以看见登陆人账户下预警数据 -->
		  and  nsrsbh in (select nsrsbh from t_sbh_zh_gx where nsrzh = #{nsrzh})
	</select>
	<!-- 删除消息推送信息 -->
	<delete id="deleteInvoiceMessage" parameterType="java.util.Map">
	   delete from t_jx_invoice_message where id in
	      <foreach collection="invList"  index="index" item="item" open="(" separator="," close=")"  >
	       '${item.id}'
	      </foreach>
	</delete>
</mapper>