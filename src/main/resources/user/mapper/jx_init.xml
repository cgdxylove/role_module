<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dzfp.cloud.common.dao.InvoiceInitDao">
	<sql id="allColumns">
		id,nsrsbh,nsr_name,init_status,check_service,period_year,
		period_month,operation_date_begin,operation_date_end,
		date_frame_begin,date_frame_end,red_warning,orange_warning,
		yellow_warning,lrsj,jt_nsrsbh,sfcp,sb_fszt,fssj_q,
		fssj_z,dzdzkTbbj	
	</sql>

	<!-- 进项发票单条认证修改 -->
	<update id="updateSkssq" >
			update t_jx_invoice_init  set 
			period_year=#{period_year},
			period_month=#{period_month},
			operation_date_end=#{operation_date_end},
			date_frame_begin=#{date_frame_begin},
			date_frame_end=#{date_frame_end}
			where nsrsbh = #{nsrsbh}	
	</update>
		
	<!-- 进项发票批量修改 -->
	<update id="updateInvoiceInit">
			update t_jx_invoice_init
			<set>
				<if test="nsrsbh !=null">nsrsbh=#{nsrsbh},</if>
				<if test="nsr_name !=null">nsr_name=#{nsr_name},</if>
				<if test="init_status !=null">init_status=#{init_status},</if>
				<if test="check_service !=null">check_service=#{check_service},</if>
				<if test="period_year !=null">period_year=#{period_year},</if>
				<if test="period_month !=null">period_month=#{period_month},</if>
				<if test="operation_date_begin !=null">operation_date_begin=#{operation_date_begin},</if>
				<if test="operation_date_end !=null">operation_date_end=#{operation_date_end},</if>
				<if test="date_frame_begin !=null">date_frame_begin=#{date_frame_begin},</if>
				<if test="date_frame_end !=null">date_frame_end=#{date_frame_end},</if>
				<if test="red_warning !=null">red_warning=#{red_warning},</if>
				<if test="orange_warning !=null">orange_warning=#{orange_warning},</if>
				<if test="yellow_warning !=null">yellow_warning=#{yellow_warning},</if>
				<if test="lrsj !=null">lrsj=#{lrsj},</if>
				<if test="jt_nsrsbh !=null">jt_nsrsbh=#{jt_nsrsbh},</if>
				<if test="sfcp !=null">sfcp=#{sfcp},</if>
				<if test="sb_fszt !=null">sb_fszt=#{sb_fszt},</if>
				<if test="fssj_q !=null">fssj_q=#{fssj_q},</if>
				<if test="fssj_z !=null">fssj_z=#{fssj_z},</if>
				<if test="dzdzkTbbj !=null">dzdzkTbbj=#{dzdzkTbbj},</if>
			</set>
			WHERE id in
		    <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
		        #{item.id}
		    </foreach>
	</update>

	<!-- 进项发票修改 -->
	<update id="updateOneInvoiceInit">
			update t_jx_invoice_init
			<set>
				<if test="nsrsbh !=null">nsrsbh=#{nsrsbh},</if>
				<if test="nsr_name !=null">nsr_name=#{nsr_name},</if>
				<if test="init_status !=null">init_status=#{init_status},</if>
				<if test="check_service !=null">check_service=#{check_service},</if>
				<if test="period_year !=null">period_year=#{period_year},</if>
				<if test="period_month !=null">period_month=#{period_month},</if>
				<if test="operation_date_begin !=null">operation_date_begin=#{operation_date_begin},</if>
				<if test="operation_date_end !=null">operation_date_end=#{operation_date_end},</if>
				<if test="date_frame_begin !=null">date_frame_begin=#{date_frame_begin},</if>
				<if test="date_frame_end !=null">date_frame_end=#{date_frame_end},</if>
				<if test="red_warning !=null">red_warning=#{red_warning},</if>
				<if test="orange_warning !=null">orange_warning=#{orange_warning},</if>
				<if test="yellow_warning !=null">yellow_warning=#{yellow_warning},</if>
				<if test="lrsj !=null">lrsj=#{lrsj},</if>
				<if test="jt_nsrsbh !=null">jt_nsrsbh=#{jt_nsrsbh},</if>
				<if test="sfcp !=null">sfcp=#{sfcp},</if>
				<if test="sb_fszt !=null">sb_fszt=#{sb_fszt},</if>
				<if test="fssj_q !=null">fssj_q=#{fssj_q},</if>
				<if test="fssj_z !=null">fssj_z=#{fssj_z},</if>
				<if test="dzdzkTbbj !=null">dzdzkTbbj=#{dzdzkTbbj},</if>
			</set>
			where id = #{id}	
	</update>
	<!-- 保存用户数据-->
	<insert id="insertOneInvoiceInit" parameterType="java.util.Map">
		insert into t_jx_invoice_init(nsrsbh,nsr_name,jt_nsrsbh,sfcp,lrsj)
		values(#{nsrsbh},#{nsrmc},#{ssjtnsrsbh},#{sfcp},#{lrsj})
	</insert>
	<insert id="insertInvoiceInit" parameterType="java.util.Map">
		insert into t_jx_invoice_init(nsrsbh,nsr_name,jt_nsrsbh,sfcp,lrsj)
		VALUES
		<foreach collection="list" item="invMap" index="index" separator=",">
			(#{invMap.nsrsbh},
			 #{invMap.nsr_name},
			 #{invMap.jt_nsrsbh},
			 #{invMap.sfcp},
			 #{invMap.lrsj})
		</foreach>
	</insert>
	
	<!-- 查询发票信息 -->
	<select id="queryInvoiceInit"  parameterType="java.util.Map" resultType="java.util.Map">
	  select 
	   <include refid="allColumns"></include>
	    from t_jx_invoice_init 
	 	WHERE nsrsbh in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
		        #{item.nsrsbh}
		</foreach>
	</select>
	<select id="checkNsrsbhByInit" parameterType="java.util.Map" resultType="java.util.Map">
	  	select 
	  		  nsrsbh,nsr_name,init_status,check_service,period_year,period_month,operation_date_begin,operation_date_end,
			  date_frame_begin,date_frame_end,red_warning,jt_nsrsbh,lrsj,sfcp,sb_fszt,fssj_q,fssj_z
		from  t_jx_invoice_init  
	   where  nsrsbh=#{nsrsbh} 
	</select>
	
	<!--根据税号，查询税款所属期信息 -->
	<select id="findSkssqxx" parameterType="java.lang.String" resultType="java.util.Map">
		select period_year, period_month, operation_date_end, date_frame_begin, date_frame_end
		from t_jx_invoice_init
		where nsrsbh = #{nsrsbh}
	</select>
	
		<!--插盘用户，根据税号，从tb_dzdzk_init_info表中，查询已维护好的税控设备 数字证书密码等信息 -->
	<select id="findCertPwd" parameterType="java.lang.String" resultType="java.util.Map">
		select tax_name,cert_pwd, qrpt_pwd, cert_token, sfjc
		from t_jx_dzdzk_init 
		where tax_no = #{nsrsbh} OR new_tax_no = #{nsrsbh}
	</select>
	
	<!-- 修改token信息 -->
	<update id="updateToken" parameterType="java.util.Map">
		update t_jx_dzdzk_init
		set cert_token = #{token},tax_name = #{nsrmc}
		where tax_no = #{nsrsbh} OR new_tax_no = #{nsrsbh}
	</update>
	
	
	<!-- 根据税号、税款所属期，从vs_t_ywlsb表中，查询某一属期的认证情况 -->
	<select id="findSkssqRzqk" parameterType="java.util.Map" resultType="java.util.Map">
		select count(1) as fs,  IFNULL(sum(synch.hjje),0) as je, IFNULL(sum(synch.hjse),0) as se,synch.nsrsbh  from  t_jx_invoice_synch synch 
		LEFT JOIN   t_jx_invoice_auth auth on synch.uuid =auth.uuid
		where 1=1
		and synch.skssq = #{skssq}
		and auth.rzzt = '1'
		and synch.nsrsbh in
		<foreach item="item" index="index" collection="nsrsbh" open="("  
	                separator="," close=")">  
	                '${item}'
	    </foreach> 
	</select>
	
	
	
	
</mapper>