<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
          "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dzfp.cloud.user.dao.NsztJbxxDao">
	<select id="queryDmLists" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		${sql}
	</select>
	<!--列表查询 -->
	<select id="queryNsztJbxxList" parameterType="java.util.Map" resultType="java.util.HashMap">
		select 
			uuid,nsrsbh,gsmc,lx,ywx,
			date_format(clrq,'%Y-%m-%d') as clrq,frdb,zczb,gdmc,cgbl,
			xzqh,zcdz,lxdh,yhzh,khyh,
			nsrxx,zt,date_format(zxsj,'%Y-%m-%d') as  zxsj,
			cjr,cjsj,xgr,xgsj,group_concat(xzqhmc) xzqhmc
		from t_pt_nszt_jbxx jb
		LEFT JOIN dm_xzqh dm on  xzqh like  CONCAT(CONCAT('%',xzqhsz_dm),'%')
		where 1=1 
	
	 	<if test="gsmc !=null and gsmc !='' ">
			and jb.gsmc like  concat(concat('%',#{gsmc}),'%')
	 	</if>
	 	<if test="lx !=null and lx !='' ">
	 		and jb.lx = #{lx}
	 	</if>
	 	<if test="nsrsbh !=null and nsrsbh!=''">
			and jb.nsrsbh like  concat(concat('%',#{nsrsbh}),'%')
   		 </if>
		<if test="nsrxx !=null and nsrxx!=''">
			and jb.nsrxx like  concat(concat('%',#{nsrxx}),'%')
		</if>
		<if test=" ywx!=null and ywx !='' ">
			and jb.ywx = #{ywx}
		</if>
		<if test="stCjsj!=null and stCjsj!='' ">
			and  DATE_FORMAT(jb.cjsj,'%Y-%m-%d') &gt;= #{stCjsj}
		</if>
		<if test="edCjsj!=null and edCjsj!='' ">
			and DATE_FORMAT(jb.cjsj,'%Y-%m-%d') &lt;= #{edCjsj}
		</if>
		<if test="xzqymc !=null and xzqymc!=''">
			and dm.xzqhmc like  concat(concat('%',#{xzqymc}),'%')
		</if>
	 	group by uuid
	 	order by cjsj  desc
	</select>
	
	<select id="getExcel" resultType="java.util.Map" parameterType="java.util.Map">
		select ${sql} 
		from t_pt_nszt_jbxx 
		LEFT JOIN dm_xzqh  on  xzqh like  CONCAT(CONCAT('%',xzqhsz_dm),'%')
		where 1=1 
	 	<if test="gsmc !=null and gsmc !='' ">
	 		and gsmc = #{gsmc}
	 	</if>
	 	<if test="lx !=null and lx !='' ">
	 		and lx = #{lx}
	 	</if>
	 	<if test="nsrsbh !=null and nsrsbh!='' ">
	   	     and nsrsbh = #{nsrsbh}
   		 </if>
	 	group by uuid
	 	order by cjsj  desc
	</select>
	
	<select id="queryNsztJbxxIsExists" parameterType="java.util.Map" resultType="int">
		select  count(*) count
		from t_pt_nszt_jbxx  where 1=1 
		<if test="nsrsbh !=null and nsrsbh !='' ">
	 		and nsrsbh = #{nsrsbh}
	 	</if>
	 	<if test="uuid !=null and uuid !='' ">
	 		and uuid != #{uuid}
	 	</if>
	</select>
	
	<insert id="saveNsztJbxx" parameterType="java.util.Map">
		INSERT INTO t_pt_nszt_jbxx 
			(uuid,nsrsbh,gsmc,lx,ywx,
			 <if test="clrq != null and clrq != ''" >
	       	 	clrq,
	      	 </if>
			frdb,zczb,gdmc,cgbl,
			xzqh,zcdz,lxdh,yhzh,khyh,
			nsrxx,zt,
			<if test="zxsj != null and zxsj != ''" >
	       	 	zxsj,
	      	</if>
			cjr,cjsj,ssjtnsrsbh)
		VALUES 
			(#{uuid},#{nsrsbh}, #{gsmc}, #{lx},#{ywx},
			<if test="clrq != null and clrq != ''" >
	       	 	#{clrq},
	      	 </if>
			#{frdb}, #{zczb}, #{gdmc},#{cgbl},
			#{xzqh},#{zcdz}, #{lxdh},#{yhzh},#{khyh},
			#{nsrxx},#{zt},
			<if test="zxsj != null and zxsj != ''" >
	       	 	#{zxsj},
	      	</if>
			#{cjr},now(),#{ssjtnsrsbh})
	</insert> 
	
	<update id="updateNsztJbxx" parameterType="java.util.Map">
		update t_pt_nszt_jbxx set
			nsrsbh=#{nsrsbh},gsmc=#{gsmc},lx=#{lx},ywx=#{ywx},
			<if test="clrq != null and clrq != ''" >
	       	 	clrq=#{clrq},
	      	</if>
			frdb=#{frdb},zczb=#{zczb},gdmc=#{gdmc},cgbl=#{cgbl},
			xzqh=#{xzqh},zcdz=#{zcdz},lxdh=#{lxdh},yhzh=#{yhzh},khyh=#{khyh},
			nsrxx=#{nsrxx},zt=#{zt},
			<if test="zxsj != null and zxsj != ''" >
	       	 	zxsj=#{zxsj},
	      	</if>
			xgr=#{xgr},xgsj=now(),ssjtnsrsbh=#{ssjtnsrsbh} 
		where uuid = #{uuid}
	</update>
	
	<delete id="deleteNsztJbxx" parameterType="String" flushCache="false">
		delete from t_pt_nszt_jbxx
		where
		uuid in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
			#{item.uuid}
		</foreach>
	</delete>


	<!-- 批量插入用具基本信息 -->
	<insert id="saveNsztJbxxList" parameterType="java.util.ArrayList">
		insert into t_pt_nszt_jbxx(
				uuid,
				nsrsbh,
				gsmc,
				lx,
				ywx,
				clrq,
				frdb,
				zczb,
				gdmc,
				cgbl,
				xzqh,
				zcdz,
				lxdh,
				yhzh,
				khyh,
				nsrxx,
				zt,
				zxsj,
				cjr,
				cjsj,
				xgr,
				xgsj,
				ssjtnsrsbh)
		values
		<foreach collection="list" item="check" separator=",">
			<trim prefix="(" suffix=")" suffixOverrides=",">
				REPLACE(UUID(),'-',''),
				<choose>
					<when  test="check.nsrsbh != null">
						#{check.nsrsbh,jdbcType=VARCHAR},
					</when >
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.gsmc != null">
						#{check.gsmc,jdbcType=VARCHAR},
					</when>
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.lx != null">
						#{check.lx,jdbcType=VARCHAR},
					</when>
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.ywx != null">
						#{check.ywx,jdbcType=VARCHAR},
					</when>
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.clrq != null">
						#{check.clrq,jdbcType=DATE},
					</when>
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.frdb != null">
						#{check.frdb,jdbcType=VARCHAR},
					</when>
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.zczb != null">
						#{check.zczb,jdbcType=VARCHAR},
					</when>
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.gdmc != null">
						#{check.gdmc,jdbcType=VARCHAR},
					</when>
					<otherwise>
						null,
					</otherwise>
				</choose>
				<choose>
					<when test="check.cgbl != null">
					#{check.cgbl,jdbcType=VARCHAR},
					</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.xzqh != null">
					#{check.xzqh,jdbcType=VARCHAR},
				</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.zcdz != null">
					#{check.zcdz,jdbcType=VARCHAR},
				</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.lxdh != null">
					#{check.lxdh,jdbcType=VARCHAR},
				</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.yhzh != null">
					#{check.yhzh,jdbcType=VARCHAR},
					</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.khyh != null">
					#{check.khyh,jdbcType=VARCHAR},
					</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.nsrxx != null">
					#{check.nsrxx,jdbcType=VARCHAR},
					</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.zt != null">
					#{check.zt,jdbcType=VARCHAR},
					</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose><when test="check.zxsj != null">
					#{check.zxsj,jdbcType=DATE},
				</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.cjr != null">
					#{check.cjr,jdbcType=VARCHAR},
				</when>
					<otherwise>null,</otherwise></choose>
				<choose>
					<when test="check.cjsj != null">
					#{check.cjsj,jdbcType=DATE},
					</when>
					<otherwise>SYSDATE(),</otherwise>
				</choose>
				<choose>
					<when test="check.xgr != null">
					#{check.xgr,jdbcType=VARCHAR},
					</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.xgsj != null">
					#{check.xgsj,jdbcType=DATE},
					</when>
					<otherwise>null,</otherwise>
				</choose>
				<choose>
					<when test="check.ssjtnsrsbh != null">
					#{check.ssjtnsrsbh,jdbcType=VARCHAR},
					</when>
					<otherwise>null,</otherwise>
				</choose>
			</trim>
		</foreach>
	</insert>


	<select id="queryNsztJbxxListByNsrsbh" resultType="map" parameterType="java.util.List">
		select count(1) as cou from t_pt_nszt_jbxx where nsrsbh in
		<foreach collection="list" index="index" item="item" open="(" separator="," close=")">
			#{item.nsrsbh}
		</foreach>
	</select>

</mapper>