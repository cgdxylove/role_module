<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
          "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dzfp.cloud.user.dao.UserDao">
	<select id="queryYhxx" parameterType="java.util.Map" resultType="java.util.HashMap">
		select a.yhid,a.nsrsbh,a.yhmc,a.yh,a.yhzt,a.ip,date_format(a.zhdlsj,'%Y-%m-%d %H:%i:%s') zhdlsj,c.jsid,c.jsmc,a.lxdh,a.yx,a.dz,a.bz,a.mm,
		(select count(1) from t_sbh_zh_gx where nsrzh = a.yh and glbj='0') cnt,
		(select count(1) from t_sbh_zh_gx where nsrzh = a.yh and glbj='1') cnt1
		from spu_t_yhxx a 
		left join spu_t_yhjs_gl b on a.yhid = b.yhid
		left join spu_t_js c on b.jsid = c.jsid
		where 1=1  
		<if test="nsrsbh != null and nsrsbh != ''">
			and a.nsrsbh = #{nsrsbh}
		</if>
		<if test="zt != null and zt != ''">
			and a.yhzt = #{zt}
		</if>
		<if test="yhmc != null and yhmc != ''">
			and a.yhmc like '%${yhmc}%'
		</if>
		<if test="jsid != null and jsid != ''">
			and c.jsid = #{jsid}
		</if>
		order by a.nsrsbh desc,a.yh
	</select>
	
	<select id="checkYh" parameterType="java.util.Map" resultType="java.util.HashMap">
		select * from spu_t_yhxx  
		where 1=1 
		<if test="yh != null and yh != ''">
			and yh  = #{yh}
		</if>
		order by nsrsbh desc,yh
	</select>
	
	<insert id="saveYhxx" parameterType="java.util.Map">
		insert into spu_t_yhxx(yhid,nsrsbh,yh,yhmc,mm,yhzt,lxdh,yx,dz,bz,lrr,lrsj)
		values(#{yhid},#{nsrsbh},#{yh},#{yhmc},#{mm},#{yhzt},#{lxdh},#{yx},#{dz},#{bz},#{lrr},#{lrsj})
	</insert>
	
	<insert id="saveYhjs" parameterType="java.util.Map">
		insert into spu_t_yhjs_gl(id,yhid,jsid,yxbz,czr,lrsj)
		values(#{id},#{yhid},#{jsid},#{yxbz},#{czr},#{lrsj})
	</insert>
	
	<update id="editYhxx" parameterType="java.util.Map">
		update spu_t_yhxx set 
			yh = #{yh},
			yhmc = #{yhmc},
			yhzt = #{yhzt},
			lxdh = #{lxdh},
			yx = #{yx},
			dz = #{dz},
			bz = #{bz},
			xgr =#{xgr},
			xgsj = #{xgsj}
		 
		where yhid  =#{yhid}
	</update>
	
	<update id="editYhjs" parameterType="java.util.Map">
		update spu_t_yhjs_gl set
			jsid = #{jsid},
			czr = #{czr},
			xgsj = #{xgsj}
		where yhid  =#{yhid}
	</update>
	<!-- 纳税人识别号和账号映射关系 主表 -->
	<select id="queryNsrsbhZMapp" parameterType="java.util.Map" resultType="java.util.HashMap">
		select b.nsrsbh,b.nsrmc  from t_sbh_zh_gx a left join spu_t_zhxx b on a.nsrsbh = b.nsrsbh
		where nsrzh = #{nsrzh} and glbj='0'
	</select>
		<!-- 纳税人识别号和账号映射关系 主表 -->
	<select id="queryNsrsbhZMappXX" parameterType="java.util.Map" resultType="java.util.HashMap">
		select b.nsrsbh,b.nsrmc  from t_sbh_zh_gx a left join spu_t_zhxx b on a.nsrsbh = b.nsrsbh
		where nsrzh = #{nsrzh} and glbj='1'
	</select>
	<!-- 纳税人识别号和账号映射关系 从表-->
	<select id="queryNsrsbhCMapp" parameterType="java.util.Map" resultType="java.util.HashMap">
		select a.nsrsbh,a.nsrmc,b.uuid from spu_t_zhxx a
		left join t_sbh_zh_gx b on a.nsrsbh = b.nsrsbh and glbj=#{glbj} and b.nsrzh = #{nsrzh} 
		where 1 =1 
		<if test="nsrsbh != null and nsrsbh != '' and nsrsbh != 'null'">
			and a.nsrsbh like concat(concat('%',#{nsrsbh}),'%')
		</if>
		<if test="nsrmc != null and nsrmc != '' and nsrmc != 'null'">
			and  a.nsrmc like concat(concat('%',#{nsrmc}),'%')
		</if>
	</select>
	<!-- 纳税人识别号和账号映射关系 删除 -->
	<delete id="delNsrMapp"  parameterType="java.util.Map">
		delete from t_sbh_zh_gx where nsrzh = #{nsrzh} and glbj=#{glbj}
	</delete>
	<!-- 纳税人识别号和账号映射关系 保存 -->
	<insert id="saveNsrMapp"  parameterType="java.util.Map">
		insert into t_sbh_zh_gx(uuid,nsrsbh,nsrzh,czr,lrsj,glbj)values
		<foreach collection="arr" index="index" item="auth" separator=",">
			(#{auth.uuid}, #{auth.nsrsbh}, #{auth.nsrzh},#{auth.czr},now(),#{auth.glbj})
		</foreach>
	</insert>

	<!-- 重置密码-->
	<update id="resetPwd" parameterType="java.util.Map">
		update spu_t_yhxx set
		mm = #{mm}
		where yhid = #{yhid}
	</update>
</mapper>